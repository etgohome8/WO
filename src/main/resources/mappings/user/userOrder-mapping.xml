<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="UserOrderDAO">
	<select id="cartList" resultType="BasketVO" parameterType="BasketVO">
		SELECT * FROM BASKET b
		INNER JOIN
		MENU m
		ON (b.M_CODE = m.M_CODE)
		INNER JOIN
		STORE_INFO s
		ON (b.SI_CODE = s.SI_CODE)
		WHERE U_ID = #{u_id}
		ORDER BY B_SEQ ASC
	</select>
	<select id="cartStore" resultType="StoreVO" parameterType="StoreVO">
		SELECT * FROM STORE_INFO WHERE 
		SI_CODE = 
		(SELECT SI_CODE FROM BASKET
		WHERE U_ID = #{u_id} LIMIT 1);
	</select>
	<insert id="insertCartItem" parameterType="BasketVO">
	
	</insert>
	
	<update id="updateCart">
		UPDATE BASKET 
		SET 
		B_QUANTITY = #{b_quantity}, 
		B_TOTAL_PRICE = #{b_total_price} 
		WHERE 
		B_SEQ = #{b_seq}
	</update>

	<select id="removeCartCheck" resultType="int">
		SELECT COUNT(*) FROM BASKET WHERE B_SEQ = #{b_seq}
	</select>
	<delete id="removeCart" parameterType="BasketVO">
		DELETE FROM BASKET WHERE B_SEQ = #{b_seq}
	</delete>
	
	<select id="dailySeq" resultType="int">
<!-- 		SELECT MAX(LPAD(o_daily_seq::text,4,'0')) FROM ORDERS  -->
		SELECT MAX(o_daily_seq) FROM ORDERS
		WHERE 
		SUBSTRING(CAST(o_order_date AS TEXT),1,10) = CAST(CURRENT_DATE AS TEXT)
	</select>
	<insert id="insertOrder">
		INSERT INTO ORDERS VALUES(default, #{o_code},#{u_id},#{si_code},default,false,null,false,0,'카드',#{o_request},0,#{o_total_price},'결제실패',#{o_list},#{o_daily_seq})
	</insert>
	<update id="successOrder">
		UPDATE ORDERS
		SET
		O_PAY_STATUS = true,
		O_ORDER_STATE = '주문접수'
		WHERE
		O_CODE = #{o_code}
	</update>
	<delete id="resetCart">
		DELETE FROM BASKET WHERE
		U_ID = #{u_id}
	</delete>
	<select id="orderComplete" resultType="OrdersVO">
		SELECT
		to_char(o_order_date, 'YYYY-MM-DD HH24:MI:SS') AS o_order_date,
		O_CODE,
		O_LIST,
		O_REQUEST,
		O_TOTAL_PRICE
		FROM ORDERS WHERE O_CODE = #{o_code}
	</select>
	<insert id="orderPointAdd">
		INSERT INTO POINT VALUES(default, #{u_id}, default, default, default,default,#{pt_amount})
	</insert>
	<update id="orderPointUpdate">
		UPDATE USERS 
		SET
		U_POINT = U_POINT+ #{pt_amount}
		WHERE
		U_ID = #{u_id}
	</update>
</mapper>
 